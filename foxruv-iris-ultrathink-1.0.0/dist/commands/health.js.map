{"version":3,"sources":["../../src/cli/commands/health.ts"],"names":["resolve"],"mappings":"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","file":"health.js","sourcesContent":["import { Command } from 'commander';\nimport chalk from 'chalk';\nimport ora from 'ora';\nimport { readFile } from 'fs/promises';\nimport { resolve } from 'path';\nimport { existsSync } from 'fs';\nimport { spawn } from 'child_process';\n\nexport const healthCommand = new Command('health')\n  .alias('check')\n  .description('Check health of MCP servers and configuration')\n  .option('-c, --config <path>', 'Configuration file', './ultrathink.config.json')\n  .option('--verbose', 'Show detailed information')\n  .action(async (options) => {\n    console.log(chalk.cyan('\\n=== Ultrathink Health Check ===\\n'));\n\n    const checks = {\n      config: false,\n      node: false,\n      dependencies: false,\n      servers: false\n    };\n\n    // Check configuration\n    const configSpinner = ora('Checking configuration...').start();\n    try {\n      const configPath = resolve(options.config);\n      if (existsSync(configPath)) {\n        const config = JSON.parse(await readFile(configPath, 'utf-8'));\n\n        if (config.wrappers && Array.isArray(config.wrappers)) {\n          checks.config = true;\n          configSpinner.succeed(chalk.green(`Configuration OK (${config.wrappers.length} wrappers)`));\n\n          if (options.verbose) {\n            config.wrappers.forEach((w: any) => {\n              console.log(chalk.gray(`  - ${w.name} (${w.enabled ? 'enabled' : 'disabled'})`));\n            });\n          }\n        } else {\n          configSpinner.warn('Configuration exists but has no wrappers');\n        }\n      } else {\n        configSpinner.fail('Configuration file not found');\n        console.log(chalk.gray(`  Run: ultrathink init`));\n      }\n    } catch (error) {\n      configSpinner.fail('Invalid configuration');\n      if (options.verbose) {\n        console.error(chalk.red('  Error:'), error);\n      }\n    }\n\n    // Check Node.js version\n    const nodeSpinner = ora('Checking Node.js version...').start();\n    try {\n      const nodeVersion = process.version;\n      const major = parseInt(nodeVersion.slice(1).split('.')[0]);\n\n      if (major >= 18) {\n        checks.node = true;\n        nodeSpinner.succeed(chalk.green(`Node.js ${nodeVersion}`));\n      } else {\n        nodeSpinner.fail(`Node.js ${nodeVersion} (>= 18.0.0 required)`);\n      }\n    } catch (error) {\n      nodeSpinner.fail('Could not determine Node.js version');\n    }\n\n    // Check dependencies\n    const depsSpinner = ora('Checking dependencies...').start();\n    try {\n      const packagePath = resolve(process.cwd(), 'package.json');\n      if (existsSync(packagePath)) {\n        const pkg = JSON.parse(await readFile(packagePath, 'utf-8'));\n        const deps = Object.keys({ ...pkg.dependencies, ...pkg.devDependencies }).length;\n\n        checks.dependencies = true;\n        depsSpinner.succeed(chalk.green(`Dependencies OK (${deps} packages)`));\n      } else {\n        depsSpinner.warn('No package.json found');\n      }\n    } catch (error) {\n      depsSpinner.fail('Could not check dependencies');\n    }\n\n    // Check MCP servers\n    const serversSpinner = ora('Checking MCP servers...').start();\n    try {\n      const configPath = resolve(options.config);\n      if (existsSync(configPath)) {\n        const config = JSON.parse(await readFile(configPath, 'utf-8'));\n        const wrappers = config.wrappers || [];\n\n        let healthyServers = 0;\n\n        for (const wrapper of wrappers.filter((w: any) => w.enabled !== false)) {\n          const isHealthy = await checkServerHealth(wrapper);\n          if (isHealthy) {\n            healthyServers++;\n            if (options.verbose) {\n              console.log(chalk.gray(`  ✓ ${wrapper.name}`));\n            }\n          } else {\n            if (options.verbose) {\n              console.log(chalk.gray(`  ✗ ${wrapper.name}`));\n            }\n          }\n        }\n\n        if (healthyServers === wrappers.length) {\n          checks.servers = true;\n          serversSpinner.succeed(chalk.green(`All servers healthy (${healthyServers}/${wrappers.length})`));\n        } else {\n          serversSpinner.warn(`Some servers unhealthy (${healthyServers}/${wrappers.length})`);\n        }\n      } else {\n        serversSpinner.info('No configuration to check');\n      }\n    } catch (error) {\n      serversSpinner.fail('Could not check servers');\n      if (options.verbose) {\n        console.error(chalk.red('  Error:'), error);\n      }\n    }\n\n    // Summary\n    console.log(chalk.cyan('\\n=== Summary ===\\n'));\n\n    const allHealthy = Object.values(checks).every(v => v);\n    const healthyCount = Object.values(checks).filter(v => v).length;\n\n    if (allHealthy) {\n      console.log(chalk.green(`✓ All checks passed (${healthyCount}/${Object.keys(checks).length})\\n`));\n      process.exit(0);\n    } else {\n      console.log(chalk.yellow(`⚠ Some checks failed (${healthyCount}/${Object.keys(checks).length})\\n`));\n      process.exit(1);\n    }\n  });\n\nasync function checkServerHealth(wrapper: any): Promise<boolean> {\n  return new Promise((resolve) => {\n    try {\n      // Try to spawn the server and check if it responds\n      const proc = spawn(wrapper.command, wrapper.args || [], {\n        env: { ...process.env, ...wrapper.env },\n        stdio: ['pipe', 'pipe', 'pipe']\n      });\n\n      let responded = false;\n\n      const timeout = setTimeout(() => {\n        if (!responded) {\n          proc.kill();\n          resolve(false);\n        }\n      }, 5000);\n\n      proc.stdout.on('data', () => {\n        responded = true;\n        clearTimeout(timeout);\n        proc.kill();\n        resolve(true);\n      });\n\n      proc.on('error', () => {\n        clearTimeout(timeout);\n        resolve(false);\n      });\n\n      // Send initialize request\n      proc.stdin.write(JSON.stringify({\n        jsonrpc: '2.0',\n        id: 1,\n        method: 'initialize',\n        params: {\n          protocolVersion: '2024-11-05',\n          capabilities: {},\n          clientInfo: { name: 'ultrathink', version: '0.1.0' }\n        }\n      }) + '\\n');\n\n    } catch (error) {\n      resolve(false);\n    }\n  });\n}\n"]}